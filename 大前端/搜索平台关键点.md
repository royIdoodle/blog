## 系统设计

本次开发的系统结构图大致如下：
![img](http://image.wangchong.tech/%E6%90%9C%E7%B4%A2%E5%B9%B3%E5%8F%B0%E7%B3%BB%E7%BB%9F%E7%BB%93%E6%9E%84.png)

系统中关键的几点：

 * 通过中间件来解决对于每个请求进行登录+权限的校验
 * 通过Etcd来实现配置信息实时同步
 * "热数据"缓存到Redis中，其他数据实时去Clickhouse和后端接口中取

### 中间件

介于数据的安全性，对于每个请求都会做**登录状态(`sso`)**和**资源权限**的校验，所以使用中间件是在合适不过的。

因为Egg中间件机制是遵循"洋葱圈"模式，每个请求都会经过各个中间件的一层层处理。

![img](http://image.wangchong.tech/ooo.png)

我们公司基建中是有`登录校验`和`资源权限校验`的`http API`，可是在我们着手开发此项目时，并没有针对`NodeJS`的sdk，于是我将这两个校验过程封装成了两个`Plugin`。

有了这两个Plugin后，今后只需要在不同环境的config文件中配置好`appKey`和`appSecret`就好。（这些是我司对于http API请求的安全校验机制，类似于微信公众平台）。

事实证明，有了这两个`Plugin`后，今后Egg项目的开发效率得到了大幅度地提升。


### 配置中心监听

#### 使用Etcd的好处

项目中的所有配置都写在了配置中心（本次项目选择用etcd），这样做有几个好处：

 1. 安全性：所有机密信息（如数据连接用户名和密码等）都不会明文暴露在代码中，etcd自带权限管理，所以只有当前项目权限的开发者才会看到关键信息
 
 2. 实时性：部分配置信息是可能随时发生变化的，项目需要与最新的配置保持同步
 
 3. 共享配置：部分配置是多个应用共享的，这样省去了维护多分数据
 
 > 介于Egg生态中并没有Etcd的插件，我自行开发了一个并且开源[Egg-Etcd](https://github.com/royIdoodle/egg-etcd)

## 系统稳定性

系统稳定性需要关注的几点：

 * 多实例+多进程：一个进程"倒下"了，立即拉起一个新的进程并关闭异常进程，保证一直有健康正常的进程来响应前端请求。
 
    本次项目是2个实例，每个实例16个进程。
    
 * 平滑重启+自动扩容： 应用部署新版本时不应该是让服务变得不可用，哪怕是一秒钟，所以需要通过多实例交替重启来实现"平滑重启"
 
    我们自有云平台的做法是 先删除一个实例pod，再拉起一个新的pod，等新pod的`存活检查`和`就绪检查`都通过后，再删除一个……这样循环，从而实现平滑重启
    
    自动扩容是当你的应用突然迎来一波流量高峰，云平台可以自动为你复制多个pod，你只需要设置满足扩容的条件即可（如CPU使用率超过85%并持续1分钟）

 * 异常监控：代码如果出现`抛出异常`，应该第一时间得知。（代码抛异常，有时并不会让系统崩溃，所以容易被人忽视）。
 
    本次项目使用了Sentry，如果发生错误，开发者会第一时间收到邮件通知
 
 * 指标监控：对于应用运行状态和指标的监控也是十分重要，如CPU使用率、内存使用率、流量等等。
 
    本次项目使用了Prometheus来监控。
    
    在Prometheus的下游，我们公司还提供了Grafana——进行指标可视化，和报警平台——通过PromQL来对关注指标进行报警，报警方式还很多，包括：邮件 => 社交软件 => 发送短信 => 拨打电话（一旦出了异常，报警是躲不掉的）

 * 日志收集：一旦出了错误，就需要分析日志，我们公司提供了云端日志收集，所以不管你有多少个实例，你的实例是否已经被销毁了，日志都是可以保留且可合并分析。
 
    公司基金为我们提供了Kibana，通过ES语法来检索日志、输出报表、图形化分析，只要确保日志格式是符合规范的，无论你使用哪种语言创建日志，都是可以以相同的方式进行检索查询及分析。

## 小结

通过上面的总结，我们的系统已经可以稳定运行了，并且形成了像下面一样的完整闭环。下一节的"性能优化"就是基于这个闭环来进行优化的。

![img](http://image.wangchong.tech/%E5%BA%94%E7%94%A8%E9%97%AD%E7%8E%AF.png)

    
## 性能优化

在上面的指标监控的加持下，在运行了一段时间后，发现了我们的数据可视化系统中，某个业务线的接口返回时间很长，大约要22s以上，这个时长是无法容忍的。




